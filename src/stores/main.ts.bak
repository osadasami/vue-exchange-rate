import { defineStore } from 'pinia'

type userInput = {
  baseCode: string
  targetCode: string
  amount: number
}

export const useConverterStore = defineStore({
  id: 'converter',
  state: () => ({
    input: '',
    baseCode: 'USD',
    targetCode: 'RUB',
    amount: 1,
    rate: null as null | number,
  }),
  getters: {
    validCodes(state) {
      return useMainStore().validCodes
    },
  },
  actions: {
    updateRate({ baseCode, targetCode, amount }: userInput) {
      this.baseCode = baseCode
      this.targetCode = targetCode
      this.amount = amount
      this.rate = amount * useMainStore().$state.data.rates[targetCode]
    },
    async onParsed(data: userInput) {
      if (data.baseCode !== this.baseCode) {
        await useMainStore().fetchRate(data.baseCode)
      }
      this.updateRate(data)
    },
  },
})

export const useMainStore = defineStore({
  id: 'main',
  state: () => ({
    data: null || ({} as any),
  }),
  getters: {
    validCodes(state): string[] {
      return Object.keys(this.data.rates)
    },
  },
  actions: {
    async fetchRate(baseCode = 'USD') {
      const res = await fetch(`https://open.er-api.com/v6/latest/${baseCode}`)
      const data = await res.json()
      this.data = data
    },
  },
})

// export const useMainStore = defineStore({
//   id: 'main',
//   state: () => ({
//     result: null || ({} as any),
//     baseCode: 'USD',
//     targetCode: 'RUB',
//     amount: 0,
//     showRates: false,
//     rate: 0,
//   }),
//   actions: {
//     async fetchRate(baseCode = 'USD') {
//       const res = await fetch(`https://open.er-api.com/v6/latest/${baseCode}`)
//       const data = await res.json()
//       this.result = data
//     },
//     async applyUserInput(amount: number, baseCode: string, targetCode: string) {
//       if (baseCode !== this.result.base_code) {
//         await this.fetchRate(baseCode)
//       }
//       this.amount = amount
//       this.baseCode = baseCode
//       this.targetCode = targetCode
//       this.rate = amount * this.result.rates[targetCode]
//       this.showRates = true
//     },
//   },
// })
